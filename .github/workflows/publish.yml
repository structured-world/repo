name: Publish Repo
run-name: Publish Repo (strongswan ${{ inputs.strongswan_run_id || github.event.client_payload.strongswan_run_id }})

on:
  workflow_dispatch:
    inputs:
      strongswan_run_id:
        description: 'strongswan build-packages run id'
        required: true
        type: string
  repository_dispatch:
    types: [publish-from-strongswan]

permissions:
  contents: write

concurrency:
  group: publish
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Generate release bot token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ secrets.RELEASER_APP_ID }}
          private-key: ${{ secrets.RELEASER_APP_PRIVATE_KEY }}

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y apt-utils createrepo-c gnupg python3-pip dpkg-dev

      - name: Import GPG key
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          if [ -n "$GPG_PASSPHRASE" ]; then
            echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 --sign --armor /dev/null || true
          fi

      - name: Resolve strongswan run id
        id: runid
        run: |
          if [ -n "${{ github.event.client_payload.strongswan_run_id }}" ]; then
            echo "run_id=${{ github.event.client_payload.strongswan_run_id }}" >> $GITHUB_OUTPUT
          else
            echo "run_id=${{ inputs.strongswan_run_id }}" >> $GITHUB_OUTPUT
          fi

      - name: Download strongswan artifacts
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          RUN_ID="${{ steps.runid.outputs.run_id }}"
          REPO="structured-world/strongswan"
          echo "Verifying workflow run $RUN_ID in $REPO..."
          if ! gh run view "$RUN_ID" -R "$REPO" --json status,conclusion,headBranch,event,workflowName,createdAt,updatedAt --jq '. as $r | "Status: \($r.status)\nConclusion: \($r.conclusion // "none")\nBranch: \($r.headBranch)\nEvent: \($r.event)\nWorkflow: \($r.workflowName)\nCreated: \($r.createdAt)\nUpdated: \($r.updatedAt)"'; then
            echo "Error: unable to view run $RUN_ID in $REPO. The run may not exist, or there may be authentication or network connectivity issues." >&2
            exit 1
          fi
          mkdir -p packages
          # NOTE: We intentionally download artifacts from the strongswan workflow run,
          # not from a release, to avoid a circular dependency (repo publish â†’ strongswan release).
          if ! gh run download "$RUN_ID" -R structured-world/strongswan -D packages; then
            echo "Error: failed to download artifacts for run $RUN_ID" >&2
            exit 1
          fi
          ls -la packages
          if ! find packages -type f | grep -q .; then
            echo "Error: no artifacts found in packages/ for run $RUN_ID" >&2
            exit 1
          fi
          if ! find packages -type f \( -name '*.rpm' -o -name '*.deb' \) | grep -q .; then
            echo "Error: no RPM/DEB artifacts found in packages/ for run $RUN_ID" >&2
            exit 1
          fi

      - name: Build docs
        run: |
          python3 -m pip install --user markdown
          SITE_BASE_URL=https://repo.sw.foundation python3 scripts/build-docs.py

      - name: Update package repositories
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          scripts/update-repos.sh

      - name: Cleanup downloaded packages
        run: |
          rm -rf packages

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "Error: publish workflow must run on main (current ref: ${{ github.ref }})" >&2
            exit 1
          fi

          [ -d deb ] && git add deb
          [ -d rpm ] && git add rpm
          [ -d docs ] && git add docs
          [ -f sitemap.xml ] && git add sitemap.xml
          [ -f robots.txt ] && git add robots.txt
          git status

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Publish packages and update docs"
            git push
          fi
