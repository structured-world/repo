name: Publish Repo

on:
  workflow_dispatch:
    inputs:
      strongswan_run_id:
        description: 'strongswan build-packages run id'
        required: true
        type: string
  repository_dispatch:
    types: [publish-from-strongswan]

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Generate release bot token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ secrets.RELEASER_APP_ID }}
          private-key: ${{ secrets.RELEASER_APP_PRIVATE_KEY }}

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y apt-utils createrepo-c gnupg python3-pip

      - name: Import GPG key
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          if [ -n "$GPG_PASSPHRASE" ]; then
            echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 --sign --armor /dev/null || true
          fi

      - name: Resolve strongswan run id
        id: runid
        run: |
          if [ -n "${{ github.event.client_payload.strongswan_run_id }}" ]; then
            echo "run_id=${{ github.event.client_payload.strongswan_run_id }}" >> $GITHUB_OUTPUT
          else
            echo "run_id=${{ inputs.strongswan_run_id }}" >> $GITHUB_OUTPUT
          fi

      - name: Download strongswan artifacts
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          RUN_ID="${{ steps.runid.outputs.run_id }}"
          mkdir -p packages
          gh run download "$RUN_ID" -R structured-world/strongswan -D packages
          ls -la packages

      - name: Build docs
        run: |
          python3 -m pip install --user markdown
          SITE_BASE_URL=https://repo.sw.foundation python3 scripts/build-docs.py

      - name: Update package repositories
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          scripts/update-repos.sh

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          git status

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Publish packages and update docs"
            git push
          fi
